<!DOCTYPE html>
<html>
<head>
    <title>RAG Document Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div style="padding: 20px; max-width: 600px;">
        <h2>RAG Document Chat</h2>
        
        <!-- Auth -->
        <div id="auth" style="margin-bottom: 20px;">
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button onclick="signIn()">Sign In</button>
            <button onclick="signUp()">Sign Up</button>
        </div>
        
        <!-- File Upload -->
        <div style="margin-bottom: 20px;">
            <input type="file" id="fileInput" accept=".pdf,.txt,.html">
            <button onclick="uploadFile()">Upload Document</button>
        </div>
        
        <!-- Query -->
        <div style="margin-bottom: 20px;">
            <input type="text" id="queryInput" placeholder="Ask a question..." style="width: 400px; padding: 8px;">
            <button onclick="askQuestion()">Ask</button>
        </div>
        
        <!-- Results -->
        <div id="results"></div>
    </div>

    <script>
        const supabase = window.supabase.createClient(
            'https://qqkmdkcynfaydivvpfer.supabase.co',
            'sb_publishable_MOyFL1lECnmmGXcOuQPhMw_tfGSQVGe'
        )
        
        const API_BASE = 'http://localhost:5000'
        
        async function signIn() {
            const email = document.getElementById('email').value
            const password = document.getElementById('password').value
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email, password
            })
            
            if (error) alert(error.message)
            else alert('Signed in successfully!')
        }
        
        async function signUp() {
            const email = document.getElementById('email').value
            const password = document.getElementById('password').value
            
            const { data, error } = await supabase.auth.signUp({
                email, password
            })
            
            if (error) alert(error.message)
            else alert('Check your email for confirmation!')
        }
        
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput')
            const file = fileInput.files[0]
            
            if (!file) {
                alert('Please select a file')
                return
            }
            
            const { data: { session } } = await supabase.auth.getSession()
            if (!session) {
                alert('Please sign in first')
                return
            }
            
            const formData = new FormData()
            formData.append('file', file)
            
            try {
                const response = await fetch(`${API_BASE}/api/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: formData
                })
                
                const result = await response.json()
                document.getElementById('results').innerHTML = 
                    `<p>✅ Upload successful! Job ID: ${result.jobId}</p>`
            } catch (error) {
                document.getElementById('results').innerHTML = 
                    `<p>❌ Upload failed: ${error.message}</p>`
            }
        }
        
        async function askQuestion() {
            const query = document.getElementById('queryInput').value
            
            if (!query) {
                alert('Please enter a question')
                return
            }
            
            const { data: { session } } = await supabase.auth.getSession()
            if (!session) {
                alert('Please sign in first')
                return
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/query`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query })
                })
                
                const result = await response.json()
                document.getElementById('results').innerHTML = 
                    `<div style="padding: 15px; background: #f5f5f5; border-radius: 5px;">
                        <strong>Answer:</strong><br>
                        ${result.answer}
                    </div>`
            } catch (error) {
                document.getElementById('results').innerHTML = 
                    `<p>❌ Query failed: ${error.message}</p>`
            }
        }
    </script>
</body>
</html>